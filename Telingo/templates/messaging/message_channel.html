{% extends 'base.html' %}
{% block bodyStyle %} <body style="width: 1080px;height: 1920px;"> {% endblock %}

{% block content %}

<!--Setup (Socketio, adapter, and variables) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
<script type="text/javascript" src="../../static/js/adapter.js"></script>
<script type="text/javascript" charset="utf-8">
  // Set up variables based on sent parameters
    var username = "{{user}}"
    var target = "{{target}}"
    var room_ID = "{{user_room}}"
    var initiator = {{identity}} //True = Initiator, False = Reciever
    var socket = io();
</script>

<h1>Video call</h1>
    <div class="row">
        <div class="col"><img class="border rounded-0" src="/static/assets/img/WebRTC-740-fi.png" width="500" height="281.25"></div>
        <div class="col">
            <div class="table-responsive" style="display: block;" >
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th rowspan="1" colspan="1">Chat</th>
                        </tr>
                    </thead>
                    <tbody id="text_chat" style="overflow: scroll; display:block; height:200px;">
                    </tbody>
                </table>
            </div><input type="text" id="message" name="message" disabled><button type="button" id="send" disabled>Send</button>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <h1 class="fs-3">Conversation Topics</h1>
            <p>example topic<br>example topic<br>example topic<br>example topic</p>
        </div>
        <div class="col">
            <h1 class="fs-3">Other user</h1>
            <p>user info<br>user info<br>user info<br>user info</p>
        </div>
    </div>


<!--Javascript Functionality (ORDER MATTERS)-->
<script type="text/javascript" src="../../static/js/messaging.js"></script>
<script type="text/javascript" charset="utf-8">
// Socket Listeners (Maybe move into JS file?)
  socket.on('connect', function() {
      socket.emit('FirstConnect', {info: 'I\'m connected!'});
      socket.emit('joinCallRoom', {room: (room_ID), initiator: (initiator)});
       // Change conditions required for this to happen, likely through some kind of join-room event listener
  });

 // Listeners to ensure connection sequence does not start until both on webpage
  socket.on('maybeStart', function(){
    console.log("Maybe Starting");
    if(connectedCount){
      console.log("Giving Go-ahead");
      socket.emit('startCall', {room: (room_ID)});
    }
    else{
      connectedCount++;
    }
  });

  socket.on('startCall', function(){
    makeCall();
  });

// Other listeners:
 // Sends message if user presses 'enter' instead of 'send' button
  var input = document.getElementById("message");
  input.addEventListener("keydown", function(e){
    if (e.key === "Enter"){
      sendMessage();
    }
  })
</script>

{% endblock%}
